---
title: "[Debate-Ducks] Debateroom - Record2"
date: 2022-07-05
categories:
  - <Projects>
tags:
  - "'Debate-Ducks'"
  - (Devlog)
---

{{< alert "lightbulb" >}}
귀국, 입원 및 수술 등의 이유로 한 달 동안 중지됐던 개발 재개
{{< /alert >}}

## Summary

토론 녹화 및 임시 다운로드 기능 재작업.

## Details

## Problems

### 녹화 영상 깨짐 현상

\# 문제

토론이 중단된 후 재시작 됐을 때 재시작 이후의 녹화 영상이 깨지는 현상이 발생한다.

<img width="800" alt="1" src="https://user-images.githubusercontent.com/84524514/177230570-faf74cc0-b0e5-48d2-8ae7-086322ccc403.png">

\# 원인

```ts
function record({
  canvasRef,
  mergedAudio,
  setRecorder,
  blobsRef,
}: Pick<
  IDebateroom,
  "canvasRef" | "mergedAudio" | "setRecorder" | "blobsRef"
>) {
  const canvasStream = canvasRef.current?.captureStream(30);

  if (!canvasStream || !mergedAudio) return;

  const mergedTracks = canvasStream.getVideoTracks().concat(mergedAudio);

  if (!mergedTracks) return;

  const mergedStream = new MediaStream(mergedTracks);

  if (!mergedStream) return;

  const recorder = new MediaRecorder(mergedStream, {
    mimeType: "video/webm",
  });

  if (!recorder) return;

  recorder.ondataavailable = (ev) => {
    blobsRef.current?.push(ev.data);
  };
  setRecorder(recorder);
}
```

```ts
useEffect(() => {
  if (!isStart) return;

  if (recorder?.state === "recording") {
    recorder?.stop();
  }
  recorder?.start(1000 / 30);
}, [isStart, recorder]);
```

recorder가 변경됐을 때 녹화를 중지하고 다시 시작하게 했으나, 이미 recorder는 변경되어 record 내부의 기존 recorder는 종료되지 않고 계속 작동하기 때문에 문제가 발생한다.

### ???

문제 잘 안됨

두번째 사람 들어올 떄 이미 있던 blobs를 보내주려 했는데 연결되는데 시간이 걸려서 에러 뜨는거

이건 connect 안에 send를 넣어서 해결

그러자 다음 에러

이건 blob을 흠

이전에 문자열 테스트 했을 때 arraybuffer로 전송 되는거 확인 그래서 이번에는 변경해서 하니까 전송은 성공 하지만 아직 이해도가 높지 않아서 추가로 공부할 것임.

문제는 순서데로 들어오는거

## Etc

### isPros 변경

기존에는 isPros(임시 변수)를 버튼을 통해 변경할 수 있는 변수로 관리했으나, 실사용 시와 좀 더 유사하게 쿼리를 통해 변경되지 않는 props로 관리하게 변경했다.

### 코드 정돈

컴포넌트 props의 타입은 Pick으로 뽑아서 사용하고 있었지만 함수는 각 인자와 타입을 따로 적어서 사용하고 있었다. Pick으로 뽑아서 사용할 인자를 중괄호로 묶어서 객체 형태로 만들어 주면 된다는 간단한 사실을 늦게 떠올렸다.

```ts
// Example
export const screenShare = async ({
  peerRef,
  stream,
  videoRef,
  screenStreamRef,
  setIsScreenOn,
}: Pick<
  IDebateroom,
  "peerRef" | "stream" | "videoRef" | "screenStreamRef" | "setIsScreenOn"
>) => {
  ...
}
```

Ps. 필요 없는 코드들이 여전히 발견된다. 코드 한 줄 한 줄을 보면서 "이 코드가 왜 필요한지? 또 이게 최선인지?"를 생각해 보는 시간을 통해서 이를 줄여나가고 있다.

### Blob in Data channel

```ts
 const blobs = blobsRef.current;
    blobs.reverse().forEach((blob) => {
      new Response(blob).arrayBuffer().then((arrayBuffer) => {
        peerRef.current?.send(arrayBuffer);
      });


    simplePeer.on("data", (arrayBuffer) => {
    const blob = new Blob([new Uint8Array(arrayBuffer)], {
      type: "video/x-matroska;codecs=avc1,opus",
    });
    blobsRef.current.unshift(blob);
  });
```
